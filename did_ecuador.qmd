---
title: "From 2x2 to GxT DID"
subtitle: "Advances, Problems and Solutions"
author: Fernando Rios-Avila
institute: "Levy Economics Institute of Bard College"
date: "2021-10-13"
format: 
    revealjs: 
        slide-number: true
        width: 1700
        height: 900
        code-fold: true
        code-overflow: wrap
        echo: true
        css: styles.css 
bibliography: did_reg.bib        
nocite: | 
  @*
---

## Why differences in diffences?

- Differences-in-Differences (DID) is one of the most popular tools in applied economics for analyzing causal effects of an intervention or policy treatment.
- Under reasonable assumptions, DID allows you to identify these effects by comparing changes in the treatment group with changes in the control group.
    - This method of identification even allows for controlling for self-selection in the treatment.
- In recent years, several advances in DID have been developed, revealing issues with the traditional DID design, particularly with the application of TWFE.
- In this course, I will briefly present the problems and solutions that have been proposed, and how they are implemented in `Stata`.

- So lets Start with the basics: 2x2 DID

## 2x2 DID: Cannonic Design

- In the 2x2 DID design, we have 2 groups:
  - Control ($D=1$) y treated ($D=0$), 
- Which are observed for two periods of time:
  - Before ($T=0$) and after ($T=1$) the treatment.
- For all groups and periods of time, we observe the *realized* outcome $Y$, but cannot observe all *potential* outcomes.
- This setup is valid both for panel data and repeat cross-sections, but will focus on panel data.
   
## Potential outcomes and Treatment Effects

- **Potential outcomes** are the outcomes we would observe for each observation in the data if it were assigned to either the treatement or control group. 
  - $Y_{i,t}(D=0)$: Potential outcome for individual $i$ at time $t$ if he was never treated.
  - $Y_{j,s}(D=1)$: Potential outcome for individual $j$ at time $s$ if he was treated.
- However, we are only able to observe one of this outcomes:
$$Y_{i,t} = Y_{i,t}(1)D_i + Y_{i,t}(0)(1-D_i)$$

- Where $D_i$ is a dummy indicates the effective treatment status of individual $i$.

- Now, we are interested in Treatment Effects for $i$, or any summary measures, after the treatment is applied:

$$TE = Y_{i,1}(1)-Y_{i,1}(0) \text{ or } ATT =E(Y_{i,1}(1)-Y_{i,1}(0)|D=1)$$


## The DID Estimator: Assumptions

- Because we can't observe both potential outcomes, we need to make assumptions to identify the treatment effect.
  
1. **Stable Unit Treatment Value Assumption (SUTVA)**: The treatment status of one unit does not affect the potential outcomes of other units. (No spillovers)

2. **Parallel Trends**: In the absence of treatment, in average, both groups would have followed the same trend (changes) over time.

$$\color{blue}{E(Y_{i,1}(0) - Y_{i,0}(0)|D_i=1)} = \color{green}{E(Y_{i,1}(0)-Y_{i,0}(0)|D_i=0)}$$
   
3. **No Anticipation**: Before the treatment takes place ($T=0$), the potential outcomes do not depend on the treatment status. 

$$Y_{i,0}(0) = Y_{i,0}(1)$$

## The DID Estimator

- Lets take a second look at the ATT definition:
$$\begin{aligned}
ATT &=E(Y_{i,1}(1)|D=1)-\color{red}{E(Y_{i,1}(0)|D=1)} \\
&=E(Y_{i,1}|D=1)-\color{red}{E(Y_{i,1}(0)|D=1)}
\end{aligned}
$$

- The problem is to estimate the **red** component, to obtain an estimator for the ATT. 

- However, under the PTA and No Anticipation, the observed part can be written as:
$$E(Y_{i,1}(0)|D=1) = E(Y_{i,1}-Y_{i,0}|D=0) + E(Y_{i,0}|D=1)
$$

- Which gives the usual ATT estimator:

$$ATT =\underbrace{E(Y_{i,1} - Y_{i,0}|D=1)}_{\Delta treat} - \underbrace{E(Y_{i,1}-Y_{i,0}|D=0)}_{\Delta control}$$ 

## Graphically

```{stata}
*| echo: false
*%%set
/*
graph_width = default
graph_height = default
*/
```

```{stata}
*| echo: false
*| fig-align: center

clear
input t d y
0 0 0.5
0 1 0.6
1 0 0.8
1 1 1.1
0 2 0.6
1 2 0.9
end

set scheme white2
color_style s2
two (scatter y t if d==0, connect(l)) ///
	(scatter y t if d==1, connect(l)) ///
	(scatter y t if d==2, connect(l)) ///
	(pci .9 1 1.1 1, lw(2) color(gs5*.5)), ///
	xscale(range(-.1 1.1)) ///
	legend(order(1 "Control" 2 "Treated" 3 "Counterfactual" 4 "ATT")) ///
    ysize(10) xsize(15)
	
```


## How to estimate it?

- **Difference-in-Means**: 
  
$$\widehat{ATT}=\bar Y^{D=1,T=1} - \bar Y^{D=1,T=0} - [ \bar Y^{D=0,T=1} - \bar Y^{D=0,T=0} ]$$

- **Regression**: 

$$Y_{i,t} = \beta_0 + \beta_1 D_i + \beta_2 t + \beta_3 (D_i \times t) + \epsilon_{i,t}$$

- With Panel Data: **Fixed Effects**
  
$$\begin{aligned}
Y_{i,t} &= \beta_0 + \sum \delta_i  + \beta_2 t + \beta_3 (D_i \times t) + \epsilon_{i,t} \\
\Delta Y_{i} &= \beta_2 + \beta_3 D_i + \epsilon_{i} \text{ for } t=0 \\
\end{aligned}
$$

## Extension: Adding Controls

- The DID estimator presented above relies on Unconditional Parallel Trends. It may work if both control and treated groups are similar in all aspects, except for the treatment. But they may not. 
- In this case, we can add controls to the model, to account for differences in the groups.

$$Y_{i,t} = \beta_0 + \beta_1 D_i + \beta_2 t + \beta_3 (D_i \times t) +  X_{it} \gamma + \epsilon_{i,t}$$

- But this would be wrong. Why?

## Problems of Adding Controls

- Simply adding controls imposes assumption of homogenous treatement effects. As described in @santanna_doubly_2020, $\gamma$ may not be the same as the ATT. 
  - Solution: Interactions between controls and all group\\time dummies:
$$y_{i,t} = \beta_0 + \sum \delta_i  + \beta_2 t + \beta_3 (D_i \times t) +  X_{it} \gamma + \sum \gamma_x (X-\bar X_{D\times T})*D*T + \epsilon_{i,t}$$

- Controlling for time varying variables may introduce biases (bad controls)
  - Solution: use only pre-treatment variables as controls. (panel) or variables that should not be affected by the treatment (cross-sections)
  - Also: If using Panel Data, one can add as controls all variables history. (see for example @caetano_difference_2022)

## Potential Solution: @santanna_doubly_2020

- DID is a straighforward estimator, that relies strongly on the Unconditional Parallel Trends Assumption. (UPTA)

- One solution to the problem is to use the **Conditional Parallel Trends Assumption** (CPTA), which can be less restrictive.

- This states that PTA holds, only after conditioning on a set of variables $X$. (looking at subgroups).

$$\color{blue}{E(Y_{i,1}(0) - Y_{i,0}(0)|D_i=1,X)} = \color{green}{E(Y_{i,1}(0)-Y_{i,0}(0)|D_i=0,X)}$$

- So, if you can "control" for individual characteristics, you could estimate the treatment effect, and still report Average Treatment Effects for the population.

$$ATT = E\big[ [E(Y_{i,1}(0) - Y_{i,0}(0)|D_i=1,X ] \big]$$

## Added Assumption

- When accouting for covariates, one needs to add an additional assumption to the data:

- There is an overlap in the distribution of $X$ between the treated and control groups. (common support)

$$0 << Pr(D=1|X) << 1$$

- This is important, because if there is no overlap, the treatment effect cannot be identified for all groups, and may create distorted estimates.

## Potential Solution: `drdid`, `teffects` 

- @santanna_doubly_2020 propose various alternatives to estimate the treatment effect with controls, under CPTA. They contrast the implementation of methods that use linear regressions, Inverse Probability Weighting (IPW) and Doubly Robust Estimators (DR).
- Similar estimates could be obtained using `teffects` in Stata.
- But how does this work? Two Cases: 
  - Panel Data: This simplifies the problem, because we can use the Data structure to estimate the model.
  - Crossection: This is more complicated because requires careful consideration of idenfication assumptions, and groups of interest.

## Panel Data 

- Step 1: Estimate the changes in the outcome $\Delta Y_i = Y_{i,1} - Y_{i,0}$. (the First D)
  - Because of this, we are implicitly reducing our sample size: from $N$ to $N/2$ (because of the unestimated fixed effects)
- Step 2: Estimate the treatment effect:
  - Simplest case, no controls:
$$\Delta Y_i = \beta_0 + \beta_1 D_i + \varepsilon_i$$ 
  
- In other words, the model is now a simple linear regression, with 1 period.

## Panel Data: Adding controls

- Because you have now only 1 period, and two groups. All treatment effect estimators can be used.
  - regression outcome, IPW, doubly robust, matching, etc.
  - We use them to estimate the second D of DID
- Empirically: With Transformed data ($\Delta y$) as dependent variable, any of the methods in `teffects` can be used to estimate the treatment effect.
- With untransformed data (RC), you can use `drdid` to estimate the treatment effect, and their Standard errors.
    - You need to make sure you have only 2 periods of data.

## Panel Data: Methods

- **Regression**: reg (`drdid`) or ra (`teffects`) 
    - using $\Delta y$ as dependent variable, estimate a linear model with covariates (No FE) for the untreated, and predict outcomes. This would become your "Potential outcome change under no-treatment"
  
$$ ATT = E(\Delta Y_{i}|D=1) - E({\hat\gamma X|D=1})$$

- **Inverse Probability Weighting**: stdipw (`drdid`) or ipw (`teffects`)
    - Estimate the likelihood of being treated, and use it to identify a propensity score and IPW weights $p(D=1|X) = \hat p(X)$
  
$$ ATT = E(\Delta Y_{i}|D=1) - E\left({\Delta Y_{i} \frac{p(X)}{1-p(X)}|D=0}\right)$$

## Panel Data: Methods

- **Doubly Robust Estimation**: dript and dripw (`drdid`) or ipwra aipw (`teffects`)
    - Estimate the likelihood of being treated, and use it to identify a propensity score and IPW weights $p(D=1|X) = \hat p(X)$
    - Estimate a weighted regression with $\Delta y$ as dependent variable or estimate a weighted regression correction. (see [here](https://friosavila.github.io/app_metrics/app_metrics2.html) slide 17-18) for more details.
    - Combinations of modeling outcome and modeling likelihood and pscores makes the estimator doubly robust.

- For Repeated crossection, the math becomes more complicated to follow and identify the "group of interest"  
- See [here](https://friosavila.github.io/app_metrics/app_metrics2.html) slide 53-54 for more details.
  
## Example {.scrollable}

Some Data Preparation

```{stata}
*| classes: larger
*| echo: true
*| code-fold: false
qui:frause lalonde, clear
keep  if treated==0 | sample==2
bysort id (year):gen dy = re[2]-re[1]
```

Using `teffects`:

```{stata}
*| classes: larger
*| echo: true
*| code-fold: false

teffects ra (dy educ black married nodegree hisp re74) (experimental) if year==1975 , atet
```

Using `drdid`:

```{stata}
*| classes: larger
*| echo: true
*| code-fold: false
 
drdid re educ black married nodegree hisp re74 , ivar(id) time(year) tr(experimental) reg
```

by hand:

```{stata}
*| classes: larger
*| echo: true
*| code-fold: false
qui:reg dy educ black married nodegree hisp re74 if exper==0
predict dy_hat, xb
gen att_i = dy-dy_hat
tabstat att_i, by(exper) 
```

## Highlights I: Identification

- The identification relies on the non-anticipation assumption and the parallel trends assumption.
  - Neither of these assumptions can be tested, but they can be supported by the data.
- For Implementation, If one has panel data, `teffects` and `drdid` can be used to estimate the treatment effect, and their standard errors. (after preparing the data)
- Otherwise, `drdid` can be used for repeated crossection as well. (or GMM)

## Highlighs II: Overlapping  

- The **overlapping** assumption is important, and has different implications for the different methods.
- When the estimation method is `reg` or `ra`, the overlapping assumption is less biding, because the model is extrapolates to created "potential outcomes" for the treated group.
  - However, extrapolation may not be accurate, or create incorrect extrapolations (base category dummies)
- With doubly robust methods, the overlapping assumption is more relevant. `dript` is particularly sensitive to this assumption, and may not even converge if there is weak overlap.
- For most practical purposes, `dripw` may be the most stable, and preferred method.

## Highlighs III: Controls

- With panel data, `drdid` automatically constrains model specification to use pre-treatment information only.
  - Added work is required to include post-treatment information.
- With Repeated crossection, `drdid` would use both pre-treatment and post-treatment information.
  
# From 2x2 to GxT DID

## How GxT DID was suppoused to work

- While the 2x2 DID design is simple to understand, it does not reflect the type of information that is available in most cases.

  - It is not uncommon to have access to multiple periods ($T>2$), with a rollout treatment ($D>2$).

- Until few years ago, when this kind of data was available, the standard approach was to use a generalized DID design, which extended the use of Fixed Effects:

$$
\begin{aligned}
2\times2: Y_{i,t} &= \beta_0 + \beta_1 T  + \beta_2 D_i + \beta_3 (D_i \times T) + \epsilon_{i,t} \\
G\times T: Y_{i,t} &= \sum \gamma_t + \sum \delta_i  + \theta^{fe} PT_{i,t} + \epsilon_{i,t} \\
\end{aligned}
$$

where $PT_{i,t}$ assume the value of 1 for the treated group After the treatment is applied, and 0 otherwise, and $\theta^{fe}$ representing the treatment effect.

- Little that we know that this approach only works if the treatment effect is homogeneous across all groups and periods.
  
## Why it doesn't work? 

There are at least two-ways that have been used to explain why the Standard TWFE does not work:

- **The "Bad Controls" Problem**: @goodmanbacon2021 shows that the TWFE estimator for ATT is a kind of weighted average of all possible DID one could estimate. Some of these would not be **good** DID designs.
- **Negative Weights**: @dechaisemartin2020 and @borusyak2023revisiting show that because TWFE ATT estimator is a weighted average of all group-Specific ATT, some may include negative weights.
  
  This may produce negative ATT even if all group-specific ATT are positive. 

- However, when the treatment effect is homogeneous, Neither of these situations would be a problem.

## The "Bad Controls" Problem

```{stata}
*| echo: false
*| output: false

clear
set obs 4
gen id = _n
gen g = 0 in 1
replace g = 4 in 2
replace g = 7 in 3
replace g = 11 in 4
gen y0 = 0+(id-3)*0.1
expand 10
bysort id:gen t = _n
bysort id:gen y = y0 + id*(t>=g)

two (scatter y t if id==1, connect(l)) ///
	(scatter y t if id==2, connect(l)) ///
	(scatter y t if id==3, connect(l)) ///	
	(scatter y t if id==4, connect(l)) , ///
	xscale(range(0 11)) xlabel(1/10) ///
	legend(order(1 "Always Treated" 2 "Early treated" 3 "Late Treated" 4 "Never Treated"))

graph export fig1.png, width(1000)	replace


two (scatter y t if id==1, connect(l)) ///
	(scatter y t if id==2, connect(l)) ///
	(scatter y t if id==3, connect(l)) ///	
	(scatter y t if id==4, connect(l)) ///
	(scatter y t if id==2 & inrange(t,1,6), connect(l) lw(1) pstyle(p2)) ///
	(scatter y t if id==3 & inrange(t,1,6), connect(l) lw(1) pstyle(p3)) , ///
	xscale(range(0 11)) xlabel(1/10) ///
	legend(order(1 "Always Treated" 2 "Early treated" 3 "Late Treated" 4 "Never Treated"))	
	
graph export fig2.png, width(1000)	replace
	
two (scatter y t if id==1, connect(l)) ///
	(scatter y t if id==2, connect(l)) ///
	(scatter y t if id==3, connect(l)) ///	
	(scatter y t if id==4, connect(l)) ///
	(scatter y t if id==2 & inrange(t,4,10), connect(l) lw(1) pstyle(p2)) ///
	(scatter y t if id==3 & inrange(t,4,10), connect(l) lw(1) pstyle(p3)) , ///
	xscale(range(0 11)) xlabel(1/10) ///
	legend(order(1 "Always Treated" 2 "Early treated" 3 "Late Treated" 4 "Never Treated"))	
graph export fig3.png, width(1000)	replace
```

:::{.panel-tabset}

## All Cases

![](fig1.png){height=50%}

## Early Treated vs Later Treated (Good)

![](fig2.png)

## Early Treated vs Later Treated (bad)

![](fig3.png)

:::

## The "Bad Controls" Problem

```{stata}
*| echo: false
*| output: false
	
	
clear
set seed 101
set obs 4
gen id = _n
gen g = 0 in 1
replace g = 4 in 2
replace g = 7 in 3
replace g = 11 in 4
gen y0 = 0+(id-3)*0.1
gen slp = runiform(-.1,0.1)
expand 10
bysort id:gen t = _n
bysort id:gen y = y0 + 0.2*id*(t>=g) + (t>=g)*(t-g)*slp

two (scatter y t if id==1, connect(l)) ///
	(scatter y t if id==2, connect(l)) ///
	(scatter y t if id==3, connect(l)) ///	
	(scatter y t if id==4, connect(l)) , ///
	xscale(range(0 11)) xlabel(1/10) ///
	legend(order(1 "Always Treated" 2 "Early treated" 3 "Late Treated" 4 "Never Treated"))

graph export fig1b.png, width(1000)	replace


two (scatter y t if id==1, connect(l)) ///
	(scatter y t if id==2, connect(l)) ///
	(scatter y t if id==3, connect(l)) ///	
	(scatter y t if id==4, connect(l)) ///
	(scatter y t if id==2 & inrange(t,1,6), connect(l) lw(1) pstyle(p2)) ///
	(scatter y t if id==3 & inrange(t,1,6), connect(l) lw(1) pstyle(p3)) , ///
	xscale(range(0 11)) xlabel(1/10) ///
	legend(order(1 "Always Treated" 2 "Early treated" 3 "Late Treated" 4 "Never Treated"))	
	
graph export fig2b.png, width(1000)	replace
	
two (scatter y t if id==1, connect(l)) ///
	(scatter y t if id==2, connect(l)) ///
	(scatter y t if id==3, connect(l)) ///	
	(scatter y t if id==4, connect(l)) ///
	(scatter y t if id==2 & inrange(t,4,10), connect(l) lw(1) pstyle(p2)) ///
	(scatter y t if id==3 & inrange(t,4,10), connect(l) lw(1) pstyle(p3)) , ///
	xscale(range(0 11)) xlabel(1/10) ///
	legend(order(1 "Always Treated" 2 "Early treated" 3 "Late Treated" 4 "Never Treated"))	
graph export fig3b.png, width(1000)	replace	
```

:::{.panel-tabset}

## All Cases

![](fig1b.png)

## Early Treated vs Later Treated (Good)

![](fig2b.png)

## Early Treated vs Later Treated (bad)

![](fig3b.png)

:::

## Negative Weights

- To understand the idea of Negative Weights, lets consider the following example:

$$Y_{i,t} = \sum \delta_i + \sum \gamma_t  + \theta PT + \epsilon_{i,t}$$

If the panel data is balanced, and we apply FWL, we can use partialling out the Fixed Effects:

$$\widetilde{PT}_{it}=PT_{it}-\overline{PT}_{i}-\overline{PT}_{t}+\overline{PT}$$

and estimate $\theta^{fe}$ as:

$$\hat\theta^{fe} = \frac{\sum \widetilde{PT_{it}} Y_{it}}{\sum \widetilde{PT}_{it}^2}
= w_{it} Y_{it}
$$

##

$$\widetilde{PT}_{it}=PT_{it}-\overline{PT}_{i}-\overline{PT}_{t}+\overline{PT}$$

- $\overline{PT}_{i}$ is the share of periods a unit is observed to be treated. (larger for early treated)
- $\overline{PT}_{t}$ is the share of units treated at time $t$. (increasing)
- $\overline{PT}$ Share of treated "unit-periods"

Thus,
- Units that are treated early, (high $\overline{PT}_{i}$)
- but are analyzed at later periods ($\overline{PT}_{t}$ increasing in $t$)

Will be more likely to have a negative weight $w_{it}$, thus contaminating the ATT estimate.

## Graphically

```{stata}
*| echo: false
*| output: false
*| fig-align: center
clear
set obs 100
gen id = _n
gen gvar = runiformint(1,10)
expand 10
bysort id:gen t =_n

gen trt = t>=gvar

reghdfe trt , abs(id t) resid
bysort gvar t:gen flag = _n
two (scatter _reghdfe_resid t if trt==1 & gvar==1 & flag==1, connect(l)) ///
	(scatter _reghdfe_resid t if trt==1 & gvar==2 & flag==1, connect(l)) ///
	(scatter _reghdfe_resid t if trt==1 & gvar==5 & flag==1, connect(l)) ///
	(scatter _reghdfe_resid t if trt==1 & gvar==6 & flag==1, connect(l)) ///
	(scatter _reghdfe_resid t if trt==1 & gvar==9 & flag==1, connect(l)) ///
	(scatter _reghdfe_resid t if trt==1 & gvar==10 & flag==1, connect(l)) , ///
	xscale(range(0 11)) ///
	legend(order(1 "Always Treated" 2 "Early Treated" 5 "Late Treated" 6 "Latest Treated"))
  
```

# Solutions

## General Overview

The root of the problem: Using incorrect control units, because of homogeneity assumption

Solutions: 
- Avoid using controls
- Add Heterogeneity in the treatment effects
- Use Only Good DID designs.

## Avoid using controls: `did_imputation` and `did2s`
#### @borusyak2023revisiting and @gardner2022twostage

## Allowing for Heterogeneity: `jwdid` and `eventstudyinteract`
#### @wooldridge_2021 and @sun_estimating_2021

## Using Good DID Designs: `csdid` and `csdid2`
#### @callaway_2021

## Map: How they Relate








## Suggested readings

::: {#refs}
::: 

